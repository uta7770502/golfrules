<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3タップルールズ</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{background:#f9fff9;font-family:"Helvetica",sans-serif;margin:0;padding-bottom:90px}
    header{background:#00bfa5;color:#fff;text-align:center;padding:16px 0;font-size:24px;font-weight:bold;border-bottom-left-radius:25px;border-bottom-right-radius:25px}
    .title{font-size:26px;font-weight:800;color:#0f8a62;margin:12px 16px 0}
    .sec{border-radius:18px;margin:14px 16px;padding:16px 16px;border:1px solid #e6e6e6;box-shadow:0 4px 10px rgba(0,0,0,.06)}
    .sec.how{background:#e8fff3;border-left:8px solid #11a371}
    .sec.pen{background:#ffe9e9;border-left:8px solid #e65757}
    .sec h2{margin:0 0 10px;font-size:20px;color:#0a8a63}
    .sec.pen h2{color:#c31313}
    .sec p{margin:8px 0 0;font-size:17px;line-height:1.8;color:#222}
    .penalty-red{color:#e60000;font-weight:800}
    .penalty-green{color:#009900;font-weight:800}
    .bottom-nav{position:fixed;left:0;bottom:0;width:100%;height:70px;background:#fff;border-top:1px solid #ddd;display:flex;justify-content:space-around;align-items:center;box-shadow:0 -2px 8px rgba(0,0,0,.05);z-index:1000}
    .bottom-nav a{display:flex;align-items:center;justify-content:center;text-decoration:none;height:100%;width:33.33%}
    .bottom-nav img{width:50px;height:auto;display:block}
    .back-btn{display:block;width:220px;margin:16px auto 6px;background:#FFD84D;color:#00997f;font-weight:800;text-align:center;border-radius:40px;padding:12px 16px;text-decoration:none;box-shadow:0 6px 14px rgba(0,0,0,.12)}
  </style>
</head>
<body>
  <header>3タップルールズ</header>

  <h1 id="ruleTitle" class="title"></h1>

  <section class="sec how">
    <h2>処置方法</h2>
    <div id="howBody"></div>
  </section>

  <section class="sec pen">
    <h2>ペナルティ</h2>
    <div id="penBody"></div>
  </section>

  <a id="backBtn" class="back-btn" href="rules.html">ルール詳細へ戻る</a>

  <nav class="bottom-nav">
    <a href="index.html"><img src="home-icon.png" alt="ホーム"></a>
    <a href="rules.html"><img src="book-icon.png" alt="ルール一覧"></a>
    <a href="favorites.html"><img src="star-icon.png" alt="お気に入り"></a>
  </nav>

<script>
  // 🔴 赤・緑ハイライト
  function highlightPenalty(text){
    if(!text) return "";
    return text
      .replace(/([0-9]+打罰|一打罰|二打罰|三打罰)/g, "<span class='penalty-red'>$1</span>")
      .replace(/(無罰|0打罰)/g, "<span class='penalty-green'>$1</span>");
  }

  // 🧩 ペナルティ自動補完関数
  function inferPenalty(rule){
    const text = [rule.title, rule.description, rule.detail].filter(Boolean).join(" ");
    if (text.match(/空振り|ストローク|スイング/)) return "1打罰。";
    if (text.match(/ロスト|OB|白杭|紛失/)) return "1打罰。";
    if (text.match(/アンプレヤブル/)) return "1打罰。";
    if (text.match(/誤球|誤所/)) return "2打罰。";
    if (text.match(/救済|修理地|カジュアル|障害物|無罰/)) return "無罰。";
    return "";
  }

  // 🧠 JSON取得と表示処理
  (async () => {
    const params = new URLSearchParams(location.search);
    const id = params.get("id");

    const titleEl = document.getElementById("ruleTitle");
    const howEl   = document.getElementById("howBody");
    const penEl   = document.getElementById("penBody");
    const backBtn = document.getElementById("backBtn");

    try {
      const res = await fetch("https://uta7770502.github.io/golfrules/rules.json?time=" + new Date().getTime(), { cache: "no-store" });
      if (!res.ok) throw new Error("fetch failed");
      const rules = await res.json();
      const rule = rules.find(r => String(r.id) === String(id));
      if (!rule) throw new Error("rule not found id=" + id);

      titleEl.textContent = rule.title || "ルール";

      let how = rule.procedure || rule.how || rule.correct || "";
      let pen = rule.penalty || rule.penalties || "";

      // 🧠 常に自動チェックして上書き
      const auto = inferPenalty(rule);
      if (auto && auto !== "" && auto !== pen) pen = auto;

      const finalHow = how || "処置方法の情報が見つかりません。";
      const finalPen = pen || "ペナルティの情報が見つかりません。";

      howEl.innerHTML = highlightPenalty(finalHow).split(/\n+/).map(p=>`<p>${p}</p>`).join("");
      penEl.innerHTML = highlightPenalty(finalPen).split(/\n+/).map(p=>`<p>${p}</p>`).join("");

      backBtn.addEventListener('click', (e) => {
        e.preventDefault();
        if (document.referrer) history.back();
        else location.href = 'rules.html';
      });

    } catch (e) {
      console.error("❌ rule_detail error:", e);
      titleEl.textContent = "内容を読み込めませんでした";
      howEl.innerHTML = "<p>処置方法の情報が見つかりません。</p>";
      penEl.innerHTML = "<p>ペナルティの情報が見つかりません。</p>";
    }
  })();
</script>
</body>
</html>
