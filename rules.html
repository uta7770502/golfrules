<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ルール一覧 | 3タップルールズ</title>
  
  <nav class="bottom-nav">
    <a href="index.html"><img src="home-icon.png" alt="ホーム" /></a>
    <a href="rules.html"><img src="book-icon.png" alt="ルール一覧" /></a>
    <a href="favorites.html"><img src="star-icon.png" alt="お気に入り" /></a>
  </nav>

  <!-- ✅ ここにスクリプト挿入 -->
  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const listContainer = document.getElementById("rules-list");
    const searchInput   = document.getElementById("searchInput");

    // ---- 正規化＆同義語マップ ---------------------------------
    const normalize = (s="") =>
      s.toLowerCase()
       .replace(/\s|　/g, "")
       .replace(/[－―—–]/g, "-")
       .replace(/ティーイング?エリア/g, "ティー")
       .replace(/グリーン上|パッティンググリーン/g, "グリーン")
       .replace(/ペナ(ルティ)?エリア|ハザード/g, "ペナルティエリア")
       .replace(/赤杭|ラテラル/g, "赤杭")
       .replace(/黄杭/g, "黄杭")
       .replace(/アンプレ(ヤブル)?/g, "アンプレ")
       .replace(/救済/g, "救済");

    const expand = (kw) => {
      const n = normalize(kw);
      const set = new Set([n]);
      if (n.includes("ティー")) set.add("ティーイングエリア");
      if (n.includes("グリーン")) set.add("グリーン上").add("パッティンググリーン");
      if (n.includes("赤杭")) set.add("ペナルティエリア").add("ラテラル");
      if (n.includes("黄杭")) set.add("ペナルティエリア");
      if (n.includes("ペナルティエリア")) set.add("赤杭").add("黄杭");
      if (n.includes("アンプレ")) set.add("アンプレヤブル");
      if (n.includes("基本ルール")) set.add("一般規則");
      if (n.includes("マナー")) set.add("エチケット");
      return Array.from(set);
    };

    const packRule = (r) => normalize(
      `${r.title||""} ${r.description||""} ${r.detail||""} ${r.category||""}`
    );

    let rules = [];
    try {
      const res = await fetch("rules.json?v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("fetch error");
      rules = await res.json();
    } catch (e) {
      console.error("❌ rules load error:", e);
      listContainer.innerHTML = "<p>ルールを読み込めませんでした。</p>";
      return;
    }

    const params = new URLSearchParams(location.search);
    const rawQuery = (params.get("q") || params.get("category") || "").trim();

    if (rawQuery) {
      searchInput.value = rawQuery;
      renderList(filterRules(rules, rawQuery));
    } else {
      renderList(rules);
    }

    searchInput.addEventListener("input", () => {
      renderList(filterRules(rules, searchInput.value));
    });

    function filterRules(all, keyword="") {
      const q = keyword.trim();
      if (!q) return all;
      const words = q.split(/[,、\s　]+/).filter(Boolean);
      const expandedBags = words.map(expand);
      return all.filter(r => {
        const hay = packRule(r);
        return expandedBags.every(bag => bag.some(key => hay.includes(key)));
      });
    }

    function renderList(list) {
      if (!list || !list.length) {
        listContainer.innerHTML = "<p>該当するルールがありません。</p>";
        return;
      }
      listContainer.innerHTML = list.map(r => `
        <button class="rule-card" onclick="location.href='rule.html?id=${r.id}'">
          ${r.title}
        </button>
      `).join("");
    }
  });
  </script>
</body>
</html>
</body>
</html>
