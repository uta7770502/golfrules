<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>„É´„Éº„É´‰∏ÄË¶ß | 3„Çø„ÉÉ„Éó„É´„Éº„É´„Ç∫</title>
  <style>
    body {
      background: #f9fff9;
      font-family: "Helvetica", sans-serif;
      margin: 0;
      padding-bottom: 90px;
      -webkit-text-size-adjust: 100%;
    }
    header {
      background: #00bfa5;
      color: #fff;
      text-align: center;
      padding: 16px 0;
      font-size: 24px;
      font-weight: bold;
      border-bottom-left-radius: 25px;
      border-bottom-right-radius: 25px;
    }
    .back-btn {
      display: block;
      width: 220px;
      text-align: center;
      background: #FFD84D;
      color: #333;
      text-decoration: none;
      margin: 20px auto;
      font-weight: bold;
      padding: 10px 0;
      border-radius: 40px;
      box-shadow: 0 5px 12px rgba(0,0,0,0.15);
      transition: 0.2s;
    }
    .back-btn:hover {
      background: #ffcc33;
      transform: translateY(-2px);
    }
    #searchArea {
      text-align: center;
      margin: 10px auto 20px;
    }
    #searchInput {
      width: 80%;
      max-width: 400px;
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 25px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      outline: none;
    }
    #rules-list {
      padding: 0 20px;
    }
    .rule-card {
      display: block;
      width: 90%;
      max-width: 500px;
      margin: 10px auto;
      padding: 14px 0;
      text-align: center;
      background: #fff;
      color: #333;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 500;
      text-decoration: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
      border: none;
      cursor: pointer;
      transition: 0.2s ease;
    }
    .rule-card:hover {
      background: #eaf9e6;
      transform: translateY(-2px);
    }
    .bottom-nav {
      position: fixed;
      left: 0; bottom: 0;
      width: 100%;
      background: #fff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 70px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
      z-index: 1000;
    }
    .bottom-nav img {
      width: 50px;
      height: auto;
      display: block;
    }
  </style>
</head>

<body>
  <header>„É´„Éº„É´‰∏ÄË¶ß</header>

  <a href="index.html" class="back-btn">„Éà„ÉÉ„Éó„Å∏Êàª„Çã</a>

  <div id="searchArea">
    <input id="searchInput" type="text" placeholder="„É´„Éº„É´„ÇíÊ§úÁ¥¢..." />
  </div>

  <main id="rules-list"></main>

  <nav class="bottom-nav">
    <a href="index.html"><img src="home-icon.png" alt="„Éõ„Éº„É†" /></a>
    <a href="rules.html"><img src="book-icon.png" alt="„É´„Éº„É´‰∏ÄË¶ß" /></a>
    <a href="favorites.html"><img src="star-icon.png" alt="„ÅäÊ∞ó„Å´ÂÖ•„Çä" /></a>
  </nav>

  <!-- ‚úÖ Ê≠£Â∏∏ÊßãÈÄ†„ÅÆ„Çπ„ÇØ„É™„Éó„Éà -->
  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const listContainer = document.getElementById("rules-list");
    const searchInput   = document.getElementById("searchInput");

    // ---- Ê≠£Ë¶èÂåñÔºÜÂêåÁæ©Ë™û„Éû„ÉÉ„Éó ---------------------------------
    const normalize = (s="") =>
      s.toLowerCase()
       .replace(/\s|„ÄÄ/g, "")
       .replace(/[Ôºç‚Äï‚Äî‚Äì]/g, "-")
       .replace(/„ÉÜ„Ç£„Éº„Ç§„É≥„Ç∞?„Ç®„É™„Ç¢/g, "„ÉÜ„Ç£„Éº")
       .replace(/„Ç∞„É™„Éº„É≥‰∏ä|„Éë„ÉÉ„ÉÜ„Ç£„É≥„Ç∞„Ç∞„É™„Éº„É≥/g, "„Ç∞„É™„Éº„É≥")
       .replace(/„Éö„Éä(„É´„ÉÜ„Ç£)?„Ç®„É™„Ç¢|„Éè„Ç∂„Éº„Éâ/g, "„Éö„Éä„É´„ÉÜ„Ç£„Ç®„É™„Ç¢")
       .replace(/Ëµ§Êù≠|„É©„ÉÜ„É©„É´/g, "Ëµ§Êù≠")
       .replace(/ÈªÑÊù≠/g, "ÈªÑÊù≠")
       .replace(/„Ç¢„É≥„Éó„É¨(„É§„Éñ„É´)?/g, "„Ç¢„É≥„Éó„É¨")
       .replace(/ÊïëÊ∏à/g, "ÊïëÊ∏à");

    const expand = (kw) => {
  const n = normalize(kw);
  const set = new Set([n]);

  // üü¢ ÂêåÁæ©Ë™û„ÉªÂà•Ë°®Ë®òÂØæÂøú
  if (n.includes("„ÉÜ„Ç£„Éº")) set.add("„ÉÜ„Ç£„Éº„Ç§„É≥„Ç∞„Ç®„É™„Ç¢");
  if (n.includes("„Éï„Çß„Ç¢„Ç¶„Çß„Ç§")) set.add("„Éï„Çß„Ç¢„Ç¶„Ç®„Ç§").add("„Éï„Çß„Ç¢„Ç¶„Ç®„Éº");
  if (n.includes("„É©„Éï")) set.add("„Çª„Éü„É©„Éï").add("„É©„ÉïÂú∞Â∏Ø");
  if (n.includes("„Ç∞„É™„Éº„É≥")) set.add("„Ç∞„É™„Éº„É≥‰∏ä").add("„Éë„ÉÉ„ÉÜ„Ç£„É≥„Ç∞„Ç∞„É™„Éº„É≥");
  if (n.includes("„Éê„É≥„Ç´„Éº")) set.add("Á†ÇÂú∞").add("„Éê„É≥„Ç´‚Äï").add("„Éê„É≥„Ç´");
  if (n.includes("Ëµ§Êù≠")) set.add("„Éö„Éä„É´„ÉÜ„Ç£„Ç®„É™„Ç¢").add("„É©„ÉÜ„É©„É´");
  if (n.includes("ÈªÑÊù≠")) set.add("„Éö„Éä„É´„ÉÜ„Ç£„Ç®„É™„Ç¢");
  if (n.includes("„Éö„Éä„É´„ÉÜ„Ç£„Ç®„É™„Ç¢")) set.add("Ëµ§Êù≠").add("ÈªÑÊù≠");
  if (n.includes("„Ç¢„É≥„Éó„É¨")) set.add("„Ç¢„É≥„Éó„É¨„É§„Éñ„É´");
  if (n.includes("Âü∫Êú¨„É´„Éº„É´")) set.add("‰∏ÄËà¨Ë¶èÂâá");
  if (n.includes("„É≠„Éº„Ç´„É´")) set.add("„É≠„Éº„Ç´„É´„É´„Éº„É´").add("ÁâπË®≠„ÉÜ„Ç£„Éº");
  if (n.includes("„Ç≥„É≥„Éö")) set.add("Á´∂ÊäÄ„É´„Éº„É´").add("Á´∂ÊäÄ‰ºö").add("„Çπ„Ç≥„Ç¢ÈõÜË®à");
  if (n.includes("„Éû„Éä„Éº")) set.add("„Ç®„ÉÅ„Ç±„ÉÉ„Éà").add("„Éó„É¨„Éº‰∏≠„ÅÆ„Éû„Éä„Éº");
  if (n.includes("„ÇØ„É©„Éñ")) set.add("Áî®ÂÖ∑").add("„ÇØ„É©„ÉñË¶èÂâá");
  if (n.includes("ÊïëÊ∏à")) set.add("„Éâ„É≠„ÉÉ„Éó").add("ÊïëÊ∏àÂá¶ÁΩÆ");

  return Array.from(set);
};

    const packRule = (r) => normalize(
      `${r.title||""} ${r.description||""} ${r.detail||""} ${r.category||""}`
    );

    let rules = [];
    try {
      const res = await fetch("rules.json?v=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("fetch error");
      rules = await res.json();
    } catch (e) {
      console.error("‚ùå rules load error:", e);
      listContainer.innerHTML = "<p>„É´„Éº„É´„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>";
      return;
    }

    const params = new URLSearchParams(location.search);
    const rawQuery = (params.get("q") || params.get("category") || "").trim();

    if (rawQuery) {
      searchInput.value = rawQuery;
      renderList(filterRules(rules, rawQuery));
    } else {
      renderList(rules);
    }

    searchInput.addEventListener("input", () => {
      renderList(filterRules(rules, searchInput.value));
    });

    function filterRules(all, keyword="") {
      const q = keyword.trim();
      if (!q) return all;
      const words = q.split(/[,„ÄÅ\s„ÄÄ]+/).filter(Boolean);
      const expandedBags = words.map(expand);
      return all.filter(r => {
        const hay = packRule(r);
        return expandedBags.every(bag => bag.some(key => hay.includes(key)));
      });
    }

    function renderList(list) {
      if (!list || !list.length) {
        listContainer.innerHTML = "<p>Ë©≤ÂΩì„Åô„Çã„É´„Éº„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>";
        return;
      }
      listContainer.innerHTML = list.map(r => `
        <button class="rule-card" onclick="location.href='rule.html?id=${r.id}'">
          ${r.title}
        </button>
      `).join("");
    }
  });
  </script>
</body>
</html>
