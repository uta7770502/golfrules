<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ãƒ«ãƒ¼ãƒ«ä¸€è¦§ | 3ã‚¿ãƒƒãƒ—ãƒ«ãƒ¼ãƒ«ã‚º</title>
  <style>
    body {
      background: #f9fff9;
      font-family: "Helvetica", sans-serif;
      margin: 0;
      padding-bottom: 90px;
      -webkit-text-size-adjust: 100%;
    }
    header {
      background: #00bfa5;
      color: #fff;
      text-align: center;
      padding: 16px 0;
      font-size: 24px;
      font-weight: bold;
      border-bottom-left-radius: 25px;
      border-bottom-right-radius: 25px;
    }
    .back-btn {
      display: block;
      width: 220px;
      text-align: center;
      background: #FFD84D;
      color: #333;
      text-decoration: none;
      margin: 20px auto;
      font-weight: bold;
      padding: 10px 0;
      border-radius: 40px;
      box-shadow: 0 5px 12px rgba(0,0,0,0.15);
      transition: 0.2s;
    }
    .back-btn:hover {
      background: #ffcc33;
      transform: translateY(-2px);
    }
    #searchArea {
      text-align: center;
      margin: 10px auto 20px;
    }
    #searchInput {
      width: 80%;
      max-width: 400px;
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 25px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      outline: none;
    }
    #rules-list {
      padding: 0 20px;
    }
    .rule-card {
      display: block;
      width: 90%;
      max-width: 500px;
      margin: 10px auto;
      padding: 14px 0;
      text-align: center;
      background: #fff;
      color: #333;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 500;
      text-decoration: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
      border: none;
      cursor: pointer;
      transition: 0.2s ease;
    }
    .rule-card:hover {
      background: #eaf9e6;
      transform: translateY(-2px);
    }
    .bottom-nav {
      position: fixed;
      left: 0; bottom: 0;
      width: 100%;
      background: #fff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 70px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
      z-index: 1000;
    }
    .bottom-nav img {
      width: 50px;
      height: auto;
      display: block;
    }
  </style>
</head>

<body>
  <header>ãƒ«ãƒ¼ãƒ«ä¸€è¦§</header>

  <a href="index.html" class="back-btn">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>

  <div id="searchArea">
    <input id="searchInput" type="text" placeholder="ãƒ«ãƒ¼ãƒ«ã‚’æ¤œç´¢..." />
  </div>

  <main id="rules-list"></main>

  <nav class="bottom-nav">
    <a href="index.html"><img src="home-icon.png" alt="ãƒ›ãƒ¼ãƒ " /></a>
    <a href="rules.html"><img src="book-icon.png" alt="ãƒ«ãƒ¼ãƒ«ä¸€è¦§" /></a>
    <a href="favorites.html"><img src="star-icon.png" alt="ãŠæ°—ã«å…¥ã‚Š" /></a>
  </nav>

  <!-- âœ… æ­£å¸¸æ§‹é€ ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
document.addEventListener("DOMContentLoaded", async () => {
  const listContainer = document.getElementById("rules-list");
  const searchInput = document.getElementById("searchInput");

  // ğŸ§© æ­£è¦åŒ–ï¼šå…¨è§’â†’åŠè§’ã€æ¿ç‚¹å¸åã€å…¨ã‚«ãƒŠå°æ–‡å­—
  // ğŸ§© æ­£è¦åŒ–ï¼šè¡¨è¨˜ã‚†ã‚Œãƒ»åŒç¾©èªå¸åï¼ˆå®Œå…¨ç‰ˆï¼‰
const normalize = (s = "") =>
  s
    .toLowerCase()
    .replace(/\s|ã€€/g, "")                          // å…¨è§’ãƒ»åŠè§’ã‚¹ãƒšãƒ¼ã‚¹é™¤å»
    .replace(/[ï¼â€•â€”â€“]/g, "-")                      // ãƒ€ãƒƒã‚·ãƒ¥çµ±ä¸€
    .replace(/ï¾ƒï½¨|ï¾ƒï½¨ï½°|ãƒ†ã‚£ãƒ¼ã‚¤ãƒ³ã‚°?ã‚¨ãƒªã‚¢/g, "ãƒ†ã‚£ãƒ¼")
    .replace(/ï¾Œï½ªï½±ï½³ï½ªï½²|ï¾Œï½ªï½±ï½³ï½´ï½²|ï¾Œï½ªï½±ï½³ï½´ï½°|ãƒ•ã‚§ã‚¢ã‚¦ã‚¨ã‚¤|ãƒ•ã‚§ã‚¢ã‚¦ã‚¨ãƒ¼/gi, "ãƒ•ã‚§ã‚¢ã‚¦ã‚§ã‚¤")
    .replace(/ï¾—ï¾Œåœ°å¸¯|ï½¾ï¾ï¾—ï¾Œ|ã‚»ãƒŸãƒ©ãƒ•/g, "ãƒ©ãƒ•")
    .replace(/ï½¸ï¾ï¾˜ï½°ï¾ä¸Š|ãƒ‘ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚°ãƒªãƒ¼ãƒ³|ï¾Šï¾Ÿï½¯ï¾ƒï½¨ï¾ï½¸ï¾ï½¸ï¾ï¾˜ï½°ï¾/g, "ã‚°ãƒªãƒ¼ãƒ³")
    .replace(/ï¾ï¾Ÿï¾…(ï¾™ï¾ƒï½¨)?ï½´ï¾˜ï½±|ï¾Šï½»ï¾ï½°ï¾„ï¾|ãƒšãƒŠ(ãƒ«ãƒ†ã‚£)?ã‚¨ãƒªã‚¢|ãƒã‚¶ãƒ¼ãƒ‰/g, "ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚¨ãƒªã‚¢")
    .replace(/èµ¤æ­|ï¾—ï¾ƒï¾—ï¾™/g, "èµ¤æ­")
    .replace(/é»„æ­/g, "é»„æ­")
    .replace(/ï½±ï¾ï¾Œï¾Ÿï¾š(ï¾”ï¾Œï¾ï¾™)?|ã‚¢ãƒ³ãƒ—ãƒ¬(ãƒ¤ãƒ–ãƒ«)?/g, "ã‚¢ãƒ³ãƒ—ãƒ¬")
    .replace(/æ•‘æ¸ˆ|ï½·ï½­ï½³ï½»ï½²/g, "æ•‘æ¸ˆ")
    .replace(/ï¾ï¾…ï½°ãƒ»?ï½´ï¾ï½¹ï½¯ï¾„|ãƒãƒŠãƒ¼ãƒ»?ã‚¨ãƒã‚±ãƒƒãƒˆ/g, "ãƒãƒŠãƒ¼ãƒ»ã‚¨ãƒã‚±ãƒƒãƒˆ")
    .replace(/ä¸€èˆ¬è¦å‰‡|åŸºæœ¬çš„ãªï¾™ï½°ï¾™/g, "åŸºæœ¬ãƒ«ãƒ¼ãƒ«")
    .replace(/ï½ºï¾ï¾ï¾Ÿï¾™ï½°ï¾™|ç«¶æŠ€ï¾™ï½°ï¾™|ç«¶æŠ€ä¼š|ï½½ï½ºï½±é›†è¨ˆ/g, "ã‚³ãƒ³ãƒšãƒ«ãƒ¼ãƒ«")
    .trim();

  // ğŸ§© åŒç¾©èªæ‹¡å¼µï¼ˆãƒœã‚¿ãƒ³â‡„categoryã®ã‚†ã‚Œå¯¾å¿œï¼‰
  const expand = (kw) => {
    const n = normalize(kw);
    const set = new Set([n]);
    if (n.includes("ãƒ†ã‚£ãƒ¼")) set.add("ãƒ†ã‚£ãƒ¼ã‚¤ãƒ³ã‚°ã‚¨ãƒªã‚¢");
    if (n.includes("ãƒ•ã‚§ã‚¢ã‚¦ã‚§ã‚¤")) set.add("ãƒ•ã‚§ã‚¢ã‚¦ã‚¨ã‚¤").add("ãƒ•ã‚§ã‚¢ã‚¦ã‚¨ãƒ¼");
    if (n.includes("ãƒ©ãƒ•")) set.add("ã‚»ãƒŸãƒ©ãƒ•").add("ãƒ©ãƒ•åœ°å¸¯");
    if (n.includes("ãƒãƒ³ã‚«ãƒ¼")) set.add("ç ‚åœ°");
    if (n.includes("ã‚°ãƒªãƒ¼ãƒ³")) set.add("ã‚°ãƒªãƒ¼ãƒ³ä¸Š").add("ãƒ‘ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚°ãƒªãƒ¼ãƒ³");
    if (n.includes("åŸºæœ¬ãƒ«ãƒ¼ãƒ«")) set.add("ä¸€èˆ¬è¦å‰‡");
    if (n.includes("ãƒ­ãƒ¼ã‚«ãƒ«")) set.add("ãƒ­ãƒ¼ã‚«ãƒ«ãƒ«ãƒ¼ãƒ«").add("ç‰¹è¨­ãƒ†ã‚£ãƒ¼");
    if (n.includes("ã‚³ãƒ³ãƒš")) set.add("ã‚³ãƒ³ãƒšãƒ«ãƒ¼ãƒ«").add("ç«¶æŠ€").add("ç«¶æŠ€ãƒ«ãƒ¼ãƒ«").add("ã‚¹ã‚³ã‚¢é›†è¨ˆ");
    if (n.includes("ãƒãƒŠãƒ¼")) set.add("ãƒãƒŠãƒ¼ãƒ»ã‚¨ãƒã‚±ãƒƒãƒˆ").add("ã‚¨ãƒã‚±ãƒƒãƒˆ");
    if (n.includes("ã‚¯ãƒ©ãƒ–")) set.add("ã‚¯ãƒ©ãƒ–è¦å‰‡").add("ç”¨å…·");
    return Array.from(set);
  };

  const packRule = (r) =>
    normalize(`${r.title || ""} ${r.description || ""} ${r.detail || ""} ${r.category || ""}`);

  // ğŸŸ¢ JSONèª­è¾¼
  let rules = [];
  try {
    const res = await fetch("rules.json?v=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("fetch error");
    rules = await res.json();
  } catch (e) {
    console.error("âŒ rules load error:", e);
    listContainer.innerHTML = "<p>ãƒ«ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
    return;
  }

  // ğŸŸ¢ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
  const params = new URLSearchParams(location.search);
  const rawQuery = (params.get("q") || params.get("category") || "").trim();

  if (rawQuery) {
    searchInput.value = rawQuery;
    renderList(filterRules(rules, rawQuery));
  } else {
    renderList(rules);
  }

  // ğŸ” å…¥åŠ›æ¤œç´¢
  searchInput.addEventListener("input", () => {
    renderList(filterRules(rules, searchInput.value));
  });

  // ğŸ” å¼·åŒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  function filterRules(all, keyword = "") {
    const q = normalize(keyword);
    if (!q) return all;

    const expanded = expand(q);

    return all.filter((r) => {
      const hay = packRule(r);
      // ã©ã®expandedèªã§ã‚‚éƒ¨åˆ†ä¸€è‡´ã—ãŸã‚‰OK
      return expanded.some((key) => hay.includes(key));
    });
  }

  // ğŸŸ© è¡¨ç¤º
  function renderList(list) {
    if (!list.length) {
      listContainer.innerHTML = "<p>è©²å½“ã™ã‚‹ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
      return;
    }
    listContainer.innerHTML = list
      .map(
        (r) => `
        <button class="rule-card" onclick="location.href='rule.html?id=${r.id}'">
          ${r.title}
        </button>`
      )
      .join("");
  }
});
</script>
</body>
</html>
