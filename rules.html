<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ãƒ«ãƒ¼ãƒ«ä¸€è¦§ | 3ã‚¿ãƒƒãƒ—ãƒ«ãƒ¼ãƒ«ã‚º</title>
  <style>
    body {
      background: #f9fff9;
      font-family: "Helvetica", sans-serif;
      margin: 0;
      padding-bottom: 90px;
      -webkit-text-size-adjust: 100%;
    }
    header {
      background: #00bfa5;
      color: #fff;
      text-align: center;
      padding: 16px 0;
      font-size: 24px;
      font-weight: bold;
      border-bottom-left-radius: 25px;
      border-bottom-right-radius: 25px;
    }
    .back-btn {
      display: block;
      width: 220px;
      text-align: center;
      background: #FFD84D;
      color: #333;
      text-decoration: none;
      margin: 20px auto;
      font-weight: bold;
      padding: 10px 0;
      border-radius: 40px;
      box-shadow: 0 5px 12px rgba(0,0,0,0.15);
      transition: 0.2s;
    }
    .back-btn:hover {
      background: #ffcc33;
      transform: translateY(-2px);
    }
    #searchArea {
      text-align: center;
      margin: 10px auto 20px;
    }
    #searchInput {
      width: 80%;
      max-width: 400px;
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 25px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      outline: none;
    }
    #rules-list {
      padding: 0 20px;
    }
    .rule-card {
      display: block;
      width: 90%;
      max-width: 500px;
      margin: 10px auto;
      padding: 14px 0;
      text-align: center;
      background: #fff;
      color: #333;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 500;
      text-decoration: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
      border: none;
      cursor: pointer;
      transition: 0.2s ease;
    }
    .rule-card:hover {
      background: #eaf9e6;
      transform: translateY(-2px);
    }
    .bottom-nav {
      position: fixed;
      left: 0; bottom: 0;
      width: 100%;
      background: #fff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 70px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
      z-index: 1000;
    }
    .bottom-nav img {
      width: 50px;
      height: auto;
      display: block;
    }
  </style>
</head>

<body>
  <header>ãƒ«ãƒ¼ãƒ«ä¸€è¦§</header>

  <a href="index.html" class="back-btn">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>

  <div id="searchArea">
    <input id="searchInput" type="text" placeholder="ãƒ«ãƒ¼ãƒ«ã‚’æ¤œç´¢..." />
  </div>

  <main id="rules-list"></main>

  <nav class="bottom-nav">
    <a href="index.html"><img src="home-icon.png" alt="ãƒ›ãƒ¼ãƒ " /></a>
    <a href="rules.html"><img src="book-icon.png" alt="ãƒ«ãƒ¼ãƒ«ä¸€è¦§" /></a>
    <a href="favorites.html"><img src="star-icon.png" alt="ãŠæ°—ã«å…¥ã‚Š" /></a>
  </nav>

  <!-- âœ… æ­£å¸¸æ§‹é€ ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
document.addEventListener("DOMContentLoaded", async () => {
  const listContainer = document.getElementById("rules-list");
  const searchInput = document.getElementById("searchInput");

  // ğŸ§© æ­£è¦åŒ–é–¢æ•°ï¼ˆå…¨è§’â†’åŠè§’ãƒ»å¤§æ–‡å­—â†’å°æ–‡å­—ï¼‰
  const normalize = (s = "") =>
    s
      .toLowerCase()
      .replace(/\s|ã€€/g, "")
      .replace(/[ï¼â€•â€”â€“]/g, "-")
      .replace(/ãƒ†ã‚£ãƒ¼ã‚¤ãƒ³ã‚°?ã‚¨ãƒªã‚¢/g, "ãƒ†ã‚£ãƒ¼")
      .replace(/ãƒ•ã‚§ã‚¢ã‚¦ã‚¨ã‚¤|ãƒ•ã‚§ã‚¢ã‚¦ã‚¨ãƒ¼/g, "ãƒ•ã‚§ã‚¢ã‚¦ã‚§ã‚¤")
      .replace(/ã‚°ãƒªãƒ¼ãƒ³ä¸Š|ãƒ‘ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚°ãƒªãƒ¼ãƒ³/g, "ã‚°ãƒªãƒ¼ãƒ³")
      .replace(/ãƒšãƒŠ(ãƒ«ãƒ†ã‚£)?ã‚¨ãƒªã‚¢|ãƒã‚¶ãƒ¼ãƒ‰/g, "ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚¨ãƒªã‚¢")
      .replace(/èµ¤æ­|ãƒ©ãƒ†ãƒ©ãƒ«/g, "èµ¤æ­")
      .replace(/é»„æ­/g, "é»„æ­")
      .replace(/ã‚¢ãƒ³ãƒ—ãƒ¬(ãƒ¤ãƒ–ãƒ«)?/g, "ã‚¢ãƒ³ãƒ—ãƒ¬")
      .replace(/æ•‘æ¸ˆ/g, "æ•‘æ¸ˆ");

  // ğŸ§© åŒç¾©èªãƒ»é–¢é€£èªæ‹¡å¼µ
  const expand = (kw) => {
    const n = normalize(kw);
    const set = new Set([n]);

    // å ´æ‰€ã‚«ãƒ†ã‚´ãƒª
    if (n.includes("ãƒ†ã‚£ãƒ¼")) set.add("ãƒ†ã‚£ãƒ¼ã‚¤ãƒ³ã‚°ã‚¨ãƒªã‚¢");
    if (n.includes("ãƒ•ã‚§ã‚¢ã‚¦ã‚§ã‚¤")) set.add("ãƒ•ã‚§ã‚¢ã‚¦ã‚¨ã‚¤").add("ãƒ•ã‚§ã‚¢ã‚¦ã‚¨ãƒ¼");
    if (n.includes("ãƒ©ãƒ•")) set.add("ã‚»ãƒŸãƒ©ãƒ•").add("ãƒ©ãƒ•åœ°å¸¯");
    if (n.includes("ãƒãƒ³ã‚«ãƒ¼")) set.add("ç ‚åœ°").add("ãƒãƒ³ã‚«â€•");
    if (n.includes("ã‚°ãƒªãƒ¼ãƒ³")) set.add("ã‚°ãƒªãƒ¼ãƒ³ä¸Š").add("ãƒ‘ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚°ãƒªãƒ¼ãƒ³");

    // ç¨®é¡ã‚«ãƒ†ã‚´ãƒª
    if (n.includes("åŸºæœ¬ãƒ«ãƒ¼ãƒ«")) set.add("ä¸€èˆ¬è¦å‰‡").add("åŸºæœ¬çš„ãªãƒ«ãƒ¼ãƒ«");
    if (n.includes("ãƒ­ãƒ¼ã‚«ãƒ«")) set.add("ãƒ­ãƒ¼ã‚«ãƒ«ãƒ«ãƒ¼ãƒ«").add("ç‰¹è¨­ãƒ†ã‚£ãƒ¼");
    if (n.includes("ã‚³ãƒ³ãƒš")) set.add("ã‚³ãƒ³ãƒšãƒ«ãƒ¼ãƒ«").add("ç«¶æŠ€ãƒ«ãƒ¼ãƒ«").add("ç«¶æŠ€ä¼š").add("ã‚¹ã‚³ã‚¢é›†è¨ˆ");
    if (n.includes("ãƒãƒŠãƒ¼")) set.add("ãƒãƒŠãƒ¼ãƒ»ã‚¨ãƒã‚±ãƒƒãƒˆ").add("ã‚¨ãƒã‚±ãƒƒãƒˆ");
    if (n.includes("ã‚¯ãƒ©ãƒ–")) set.add("ã‚¯ãƒ©ãƒ–è¦å‰‡").add("ç”¨å…·");

    return Array.from(set);
  };

  const packRule = (r) =>
    normalize(`${r.title || ""} ${r.description || ""} ${r.detail || ""} ${r.category || ""}`);

  // ğŸŸ¢ JSONèª­è¾¼
  let rules = [];
  try {
    const res = await fetch("rules.json?v=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("fetch error");
    rules = await res.json();
  } catch (e) {
    console.error("âŒ rules load error:", e);
    listContainer.innerHTML = "<p>ãƒ«ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
    return;
  }

  // ğŸŸ¢ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—ï¼ˆq ã¾ãŸã¯ categoryï¼‰
  const params = new URLSearchParams(location.search);
  const rawQuery = (params.get("q") || params.get("category") || "").trim();

  // åˆå›è¡¨ç¤º
  if (rawQuery) {
    searchInput.value = rawQuery;
    renderList(filterRules(rules, rawQuery));
  } else {
    renderList(rules);
  }

  // ğŸ” å…¥åŠ›æ¤œç´¢
  searchInput.addEventListener("input", () => {
    renderList(filterRules(rules, searchInput.value));
  });

  // ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†
  function filterRules(all, keyword = "") {
    const q = keyword.trim();
    if (!q) return all;

    const words = q.split(/[,ã€\sã€€]+/).filter(Boolean);
    const expandedBags = words.map(expand);

    return all.filter((r) => {
      const hay = packRule(r);
      return expandedBags.some((bag) => bag.some((key) => hay.includes(key)));
    });
  }

  // ğŸŸ© ãƒ«ãƒ¼ãƒ«ä¸€è¦§ã‚’æç”»
  function renderList(list) {
    if (!list || !list.length) {
      listContainer.innerHTML = "<p>è©²å½“ã™ã‚‹ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
      return;
    }
    listContainer.innerHTML = list
      .map(
        (r) => `
        <button class="rule-card" onclick="location.href='rule.html?id=${r.id}'">
          ${r.title}
        </button>
      `
      )
      .join("");
  }
});
</script>
</body>
</html>
