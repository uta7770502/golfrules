<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ルール一覧 | 3タップルールズ</title>
  <script>
document.addEventListener("DOMContentLoaded", async () => {
  const listContainer = document.getElementById("rules-list");
  const searchInput   = document.getElementById("searchInput");

  // ---- 正規化＆同義語マップ ---------------------------------
  const normalize = (s="") =>
    s.toLowerCase()
     .replace(/\s|　/g, "")         // 空白除去（半角/全角）
     .replace(/[－―—–]/g, "-")     // ダッシュ類
     .replace(/ティーイング?エリア/g, "ティー")
     .replace(/グリーン上|パッティンググリーン/g, "グリーン")
     .replace(/バンカ-/g, "バンカー")
     .replace(/ペナ(ルティ)?エリア|ハザード/g, "ペナルティエリア")
     .replace(/赤杭|ラテラル/g, "赤杭")
     .replace(/黄杭/g, "黄杭")
     .replace(/ob/g, "ob")
     .replace(/アンプレ(ヤブル)?/g, "アンプレ")
     .replace(/修理地/g, "修理地")
     .replace(/救済/g, "救済");

  // キーワードを同義語セットに展開（どれか当たればOK）
  const expand = (kw) => {
    const n = normalize(kw);
    const set = new Set([n]);

    if (n.includes("ティー")) { set.add("ティー"); }
    if (n.includes("グリーン")) { set.add("グリーン"); }
    if (n.includes("フェアウェイ")) { set.add("フェアウェイ"); }
    if (n.includes("ラフ")) { set.add("ラフ"); }
    if (n.includes("バンカー")) { set.add("バンカー"); }
    if (n.includes("赤杭")) { set.add("ペナルティエリア"); set.add("ラテラル"); }
    if (n.includes("黄杭")) { set.add("ペナルティエリア"); }
    if (n.includes("ペナルティエリア")) { set.add("赤杭"); set.add("黄杭"); }
    if (n.includes("アンプレ")) { set.add("アンプレ"); set.add("アンプレヤブル"); }
    if (n.includes("基本ルール")) { set.add("一般規則"); }
    if (n.includes("ローカル")) { set.add("ローカルルール"); }
    if (n.includes("コンペ")) { set.add("コンペルール"); }
    if (n.includes("マナー")) { set.add("マナー・エチケット"); set.add("エチケット"); }
    if (n.includes("クラブ")) { set.add("装備"); }

    return Array.from(set);
  };

  // 1つのルールを正規化テキスト化
  const packRule = (r) => normalize(
    `${r.title||""} ${r.description||""} ${r.detail||""} ${r.category||""}`
  );

  // 実データ読み込み
  let rules = [];
  try {
    const res = await fetch("rules.json?v=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("fetch error");
    rules = await res.json();
  } catch (e) {
    console.error("❌ rules load error:", e);
    listContainer.innerHTML = "<p>ルールを読み込めませんでした。</p>";
    return;
  }

  // URL パラメータ（q / category 両対応）
  const params = new URLSearchParams(location.search);
  const rawQuery = (params.get("q") || params.get("category") || "").trim();

  // 初回表示
  if (rawQuery) {
    searchInput.value = rawQuery;
    renderList(filterRules(rules, rawQuery));
  } else {
    renderList(rules);
  }

  // 入力検索
  searchInput.addEventListener("input", () => {
    renderList(filterRules(rules, searchInput.value));
  });

  // 絞り込み本体（同義語・部分一致・全角半角吸収）
  function filterRules(all, keyword="") {
    const q = keyword.trim();
    if (!q) return all;

    // カンマ区切り／空白区切りも許容（複数ワード AND）
    const words = q.split(/[,、\s　]+/).filter(Boolean);
    const expandedBags = words.map(expand); // 各ワード→同義語袋

    return all.filter(r => {
      const hay = packRule(r); // ルールの統合テキスト
      // すべてのワード袋について「どれか1つでも当たる」= AND のつもり
      return expandedBags.every(bag => bag.some(key => hay.includes(key)));
    });
  }

  // 一覧描画（デザイン変更なし）
  function renderList(list) {
    if (!list || !list.length) {
      listContainer.innerHTML = "<p>該当するルールがありません。</p>";
      return;
    }
    listContainer.innerHTML = list.map(r => `
      <button class="rule-card" onclick="location.href='rule.html?id=${r.id}'">
        ${r.title}
      </button>
    `).join("");
  }
});
</script>
</head>
<body>
  <header>ルール一覧</header>
  <a href="index.html" class="back-btn">トップへ戻る</a>

  <div id="searchArea">
    <input id="searchInput" type="text" placeholder="ルールを検索..." />
  </div>

  <main id="rules-list"></main>

  <nav class="bottom-nav">
    <a href="index.html"><img src="home-icon.png" alt="ホーム" /></a>
    <a href="rules.html"><img src="book-icon.png" alt="ルール一覧" /></a>
    <a href="favorites.html"><img src="star-icon.png" alt="お気に入り" /></a>
  </nav>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const listContainer = document.getElementById("rules-list");
  const searchInput   = document.getElementById("searchInput");

  // ✅ カテゴリ→検索語のゆるい対応表（タグが無くてもヒットさせる）
  const KEYWORD_MAP = {
    "ティー": ["ティー", "ティーショット", "ティーグラウンド"],
    "フェアウェイ": ["フェアウェイ"],
    "ラフ": ["ラフ"],
    "バンカー": ["バンカー"],
    "グリーン": ["グリーン", "グリーン上", "パッティンググリーン"],
    "基本ルール": ["基本ルール", "基礎", "ストローク", "空振り", "ドロップ"],
    "ローカルルール": ["ローカル", "ローカルルール", "特設", "白杭内プレー禁止"],
    "コンペルール": ["コンペ", "新ペリ", "ダブルペリア", "ニアピン", "ドラコン", "HDCP"],
    "マナー・エチケット": ["マナー", "エチケット", "安全", "スロープレー", "服装"],
    "クラブ": ["クラブ", "クラブ選択", "用具", "14本", "違反クラブ"]
  };

  // ---------- ルール読み込み ----------
  try {
    const jsonUrl = `${location.origin}${location.pathname.replace(/\/[^/]*$/, '')}/rules.json?v=${Date.now()}`;
    const res = await fetch(jsonUrl);
    if (!res.ok) throw new Error("ルールデータが読み込めませんでした");
    const rules = await res.json();

    // ---------- URLパラメータ(q / category) ----------
    const params   = new URLSearchParams(location.search);
    const qRaw     = params.get("q");
    const catRaw   = params.get("category");
    const query    = (qRaw ?? catRaw ?? "").trim();

    // 初期表示
    if (query) {
      searchInput.value = query;
      renderList(filterByQuery(rules, query));
    } else {
      renderList(rules);
    }

    // 検索ボックス連動
    searchInput.addEventListener("input", () => {
      const q = searchInput.value.trim();
      renderList(filterByQuery(rules, q));
    });

    // ---------- 検索ロジック ----------
    function filterByQuery(all, keyword) {
      if (!keyword) return all;

      // 対応表にあれば別名も含めて検索、無ければそのまま
      const keys = KEYWORD_MAP[keyword] || [keyword];
      const keysLower = keys.map(k => k.toLowerCase());

      return all.filter(r => {
        const text = [
          r.title, r.description, r.detail,
          r.category, (r.tags || []).join(" ")
        ].filter(Boolean).join(" ").toLowerCase();

        // どれか1つでも含まれればヒット
        return keysLower.some(k => text.includes(k));
      });
    }

    // ---------- 一覧描画 ----------
    function renderList(list) {
      if (!list || !list.length) {
        listContainer.innerHTML = "<p>該当するルールがありません。</p>";
        return;
      }
      listContainer.innerHTML = list.map(r => `
        <button class="rule-card" onclick="location.href='rule.html?id=${r.id}'">
          ${r.title}
        </button>
      `).join("");
    }
  } catch (err) {
    console.error(err);
    listContainer.innerHTML = "<p>ルールを読み込めませんでした。</p>";
  }
});
</script>
</body>
</html>
